# 30DaysMakeOS
开始看川合秀实的《30天自制操作系统》。

原本并不喜欢“多少天做什么”这样的书，但是最近看操作系统相关的知识有些头疼，无意中又看到了这样一本书，所以就拿过来看一看。

写得好与不好，暂且不论，总之先看再说。

就这样。

## Day01
第一天的东西很简单，汇编的基本也很容易。

把`run.bat`的内容稍微改了一下，这样可以每次修改`hello.nas`之后直接双击`run.bat`就可以看到效果了。

## Day02
把`.nas`的后缀改成了`.asm`，不会对最终效果产生什么影响。

只是不用手动在Notepad++中选择语言高亮了。

`Makefile`中的`install`任务无法执行，因为`imgtol.com`与64位系统不兼容。

## Day03
没想到改了后缀名还挺麻烦的，每次都要改`Makefile`，不过自己挖的坑，就跳下去吧。

那个长长的汇编程序，没看懂……嗯，看不懂就对了，笑。

啊，我要说什么来的。

好像是很重要的事情，不过等想起来再补上吧。笑。
## Day04
这两天再看《程序员的自我修养》，讲到`.o`文件之类的文件结构。

其中有一部分是`.text`区，用来放编译好的代码。

所以这本书中的`.nas`（我又改成`.asm`了）文件其实写的是C语言中的方法汇编成汇编语言的样子。

好像书中也这么说了。

这次很多C代码，看得比较轻松。

显示颜色的时候换数字玩了好几次，玩得还很开心。

把程序换成了自己喜欢的写法。

还没弄完，明天继续。

第四天的部分弄完了。

所谓的显示，就是把颜色的数据填进了显存当中。

`boxfill8()`这个函数其实就是画矩形。

最后的代码保留了原本画出混乱颜色的循环和画矩形的循环。把整个画面填充成*浅暗蓝色*的那一行代码注释掉了（就是第一次调用`boxfill8()`函数的地方）。

这样显示出来的“伪桌面”就是这样的：
![“混乱的桌面”](https://github.com/nagisatk/30DaysMakeOS/blob/master/day04/desktop.jpg)
## Day05
保留了文字。

换了背景色，懒得调。。要赶紧走了。
## Day06
今天发现之前一直把调色板这个单词写错了。

不过也没有把前五天的代码中的这个单词改过来。
## Day07
今天讲的是键盘和鼠标，不过鼠标还是没有动起来。

FIFO缓冲区也就是队列，记得曾经实现过一个，不过代码已经不知道送到哪里去了。
## Day08
今天的汇编讲的有点难懂，可能是因为我之前汇编只是大致看了一下，没有深入的了解。

补上一点关于段的笔记：
1. GDT是全局段记号表；
2. 根据Page 101~103的说法，段是一块内存空间；
3. 段号一共有8192个，也就是2^13个，分割合计4GB = 2^32Byte内存；
4. GDT的起始地址由操作系统决定。
5. 实际上可供GDT分配的内存空间应该不到4GB（在32位系统中），所以Page 103才会写“（实际上也可以比这少）”。这一条是我自己想的，不知道对不对。
在补上一点关于IDT的笔记：
1. IDT是中断记录表；
2. 根据Page 103的说法，中断用来处理“外部变化，或者内部偶然发生某些错误”；
3. 维基页面：[中断](https://zh.wikipedia.org/wiki/%E4%B8%AD%E6%96%B7)。
## Day09
已经这么晚了。。。

内存管理的函数基本上还是很简单的，虽然我知道作者一定是把内存管理简化又简化了。

之前偶然看到后记，作者自己也吐槽自己的内存管理十分粗陋。

觉得很有趣。

被优化掉的函数被写成了汇编，虽然我之前不太注意汇编，但这次却基本上看懂了。

真是不错。
## Day10
终于到了第10天。前几天还觉得完成遥遥无期，今天忽然发现已经做了三分之一。

今天做叠加处理的时候，背景变成了奇怪的颜色。是因为尽管对`buf_back`进行了赋值，但绘制的时候依旧使用的`binfo->buf`。
![奇怪颜色的背景](https://github.com/nagisatk/30DaysMakeOS/blob/master/day10/stange_color_background.png)
另外，鼠标的叠加处理也出现了错误，还是会把下方的伪任务栏覆盖掉，原因是多调用了一次重绘鼠标的方法。

在写完`sheet_slide`之后，鼠标的移动也交给了这个函数，所以不需要重绘鼠标。
## Day 11
周六。
由于出没时间的不确定性，所以并不能确认每天都能看书。

今天本来想看他两三天的量，但完成一天的量已经快八点了。为了我还能回去睡觉，今天就到这儿吧。

其实已经完成了一会儿，不过之前因为赶时间而没有细读的几个刷新函数并不是理解的十分透彻，今天仔细读了一遍前边关于这几个函数的段落。在书上记了一些笔记。

或许在已经明白的人看来，都是很简单的笔记。不过，对我来说还是很有帮助的。

定时器的问题明天在看吧。

或许我应该不那么执着于每天都完成一天的工作量，不然以后恐怕还是会出现今天这种返工的事情。

但返工似乎也有返工的乐趣，笑。
## Day 12
把之前的FIFO的代码读了一遍。

因为设定每秒刷新的字符并没有正确地刷新，重新看了一遍前面的代码。

然后发现，是因为坐标写错了。
## Day 13
优化性能的部分是将队列改成了单链表。

加入“哨兵”是第一次看到的做法，很有趣。
## Day 14
终于能打字了。
## Day 15
这一天拖了好久，并没有能够连续看书。

按照书上写代码的时候，有一句比较奇怪的代码：
`*((int *) 0xFEC) = (int) sht_back;`
本来我以为是C语言中的什么奇技淫巧，看了一会儿发现并不是那么回事。

这段代码的意思是将`sht_back`强制转换成`int`值写到内存地址`0xFEC`的位置。

如果加入一个中间变量，会容易理解很多：
```C
int *a;
a = (int *) 0xFEC;
*a = (int) sht_back;
```